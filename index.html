<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-–ß–∞—Ç v1.2 (–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ)</title>
    <style>
        /* --- –¢–µ–º—ã --- */
        :root { --font-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .theme-dark { --bg-primary: #1d2127; --bg-secondary: #282c34; --bg-tertiary: #3a4049; --text-primary: #e2e2e2; --text-secondary: #a0a0a0; --user-msg-bg: #3498db; --bot-msg-bg: #3a4049; --input-focus-border: #9b59b6; --shadow-color: rgba(0, 0, 0, 0.4); --border-color: #444a55; }
        .theme-light { --bg-primary: #f0f2f5; --bg-secondary: #ffffff; --bg-tertiary: #e4e6eb; --text-primary: #050505; --text-secondary: #65676b; --user-msg-bg: #1877f2; --bot-msg-bg: #e4e6eb; --input-focus-border: #1877f2; --shadow-color: rgba(0, 0, 0, 0.1); --border-color: #ced0d4; }
        .theme-oceanic { --bg-primary: #0f2027; --bg-secondary: #203a43; --bg-tertiary: #2c5364; --text-primary: #e0f7fa; --text-secondary: #b2ebf2; --user-msg-bg: #16a085; --bot-msg-bg: #2c5364; --input-focus-border: #1dd3a6; --shadow-color: rgba(0, 0, 0, 0.4); --border-color: #4a6e7e; }

        /* --- –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ --- */
        body { margin: 0; font-family: var(--font-main); background-color: var(--bg-primary); color: var(--text-primary); transition: background-color 0.3s ease, color 0.3s ease; overflow: hidden; }
        #app-container { position: relative; width: 100vw; height: 100vh; display: flex; justify-content: center; align-items: center; }
        #chat { position: relative; width: 100%; max-width: 800px; height: 95vh; display: flex; flex-direction: column; background: var(--bg-secondary); border-radius: 16px; box-shadow: 0 10px 30px var(--shadow-color); border: 1px solid var(--border-color); overflow: hidden; z-index: 10; transition: transform 0.4s ease; }

        /* --- Header --- */
        #header { padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); }
        #header h2 { margin: 0; font-size: 1.2rem; color: var(--text-secondary); }
        #header-controls { display: flex; gap: 10px; align-items: center; }
        .header-btn, #attach-btn { background: none; border: none; color: var(--text-secondary); font-size: 1.5rem; cursor: pointer; padding: 5px; border-radius: 50%; transition: background-color 0.2s, color 0.2s; }
        .header-btn:hover, #attach-btn:hover { background-color: var(--bg-tertiary); color: var(--text-primary); }
        #user-avatar { width: 32px; height: 32px; border-radius: 50%; background-color: var(--input-focus-border); color: #fff; display: flex; justify-content: center; align-items: center; font-weight: bold; cursor: pointer; user-select: none; }
        
        /* --- –°–æ–æ–±—â–µ–Ω–∏—è --- */
        #msgs { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .msg { max-width: 80%; padding: 12px 18px; border-radius: 20px; line-height: 1.5; word-wrap: break-word; animation: message-appear 0.4s ease both; }
        @keyframes message-appear { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        .user { align-self: flex-end; background: var(--user-msg-bg); color: #fff; border-bottom-right-radius: 5px; }
        .bot { align-self: flex-start; background: var(--bot-msg-bg); color: var(--text-primary); border-bottom-left-radius: 5px; white-space: pre-wrap; }
        .error { background-color: #c0392b; color: white; border: 1px solid #e74c3c; }

        /* --- Toolbar --- */
        #toolbar { display: flex; flex-direction: column; padding: 10px 20px 20px 20px; border-top: 1px solid var(--border-color); }
        #image-preview-container { display: none; position: relative; width: 100px; height: 100px; margin-bottom: 10px; }
        #preview-image { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; }
        #remove-image-btn { position: absolute; top: -5px; right: -5px; background: #000; color: #fff; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 1rem; }
        #input-row { display: flex; gap: 15px; align-items: center; width: 100%; }
        #userInput { flex: 1; padding: 14px 20px; font-size: 1rem; border: 1px solid var(--border-color); border-radius: 24px; background: var(--bg-secondary); color: var(--text-primary); }
        #userInput:focus { outline: none; border-color: var(--input-focus-border); }
        #sendBtn { position: relative; width: 48px; height: 48px; flex-shrink: 0; border: none; border-radius: 50%; background: var(--input-focus-border); color: #fff; cursor: pointer; transition: all .2s; font-size: 1.5rem; display: flex; justify-content: center; align-items: center; }
        #sendBtn.cooldown { background-color: #c0392b; cursor: not-allowed; }
        .loader { width: 24px; height: 24px; border: 3px solid rgba(255, 255, 255, 0.3); border-top-color: #fff; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- –ë–æ–∫–æ–≤—ã–µ –ø–∞–Ω–µ–ª–∏, –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –∏ –≤–µ—Ä—Å–∏—è (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) --- */
        .side-panel { position: fixed; top: 0; width: 300px; height: 100%; background: var(--bg-primary); box-shadow: 0 0 30px var(--shadow-color); z-index: 1000; transition: transform 0.4s ease; padding: 20px; display: flex; flex-direction: column; }
        #history-panel { left: 0; transform: translateX(-100%); }
        #settings-panel { right: 0; transform: translateX(100%); }
        #history-panel.active, #settings-panel.active { transform: translateX(0); }
        .panel-header { padding-bottom: 15px; border-bottom: 1px solid var(--border-color); margin-bottom: 15px; }
        .panel-content { flex: 1; overflow-y: auto; }
        #chat-list { list-style: none; padding: 0; margin: 0; }
        #chat-list li { padding: 15px; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: flex; justify-content: space-between; align-items: center; }
        #chat-list li:hover { background-color: var(--bg-tertiary); }
        #chat-list li.active { background-color: var(--input-focus-border); color: #fff; }
        .delete-chat-btn { background: none; border: none; color: var(--text-secondary); font-size: 1.2rem; cursor: pointer; opacity: 0.5; }
        #chat-list li:hover .delete-chat-btn { opacity: 1; }
        .settings-section { margin-bottom: 25px; }
        .settings-section h3 { margin-top: 0; margin-bottom: 10px; color: var(--text-secondary); }
        textarea, select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-tertiary); color: var(--text-primary); font-size: 0.9rem; box-sizing: border-box; }
        textarea { min-height: 100px; resize: vertical; }
        .theme-options { display: flex; gap: 15px; }
        .theme-dot { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 3px solid var(--border-color); }
        .theme-dot.active { border-color: var(--input-focus-border); }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: none; justify-content: center; align-items: center; }
        .modal-content { background: var(--bg-secondary); padding: 30px 40px; border-radius: 16px; text-align: center; box-shadow: 0 5px 25px rgba(0,0,0,0.5); width: 90%; max-width: 400px; }
        .modal-content h3 { margin-top: 0; }
        .modal-content input { margin: 20px 0; width: 100%; padding: 10px; box-sizing: border-box; }
        .modal-content button { width: 100%; padding: 12px; border-radius: 8px; border: none; background: var(--input-focus-border); color: white; cursor: pointer; }
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 500; display: none; }
        #version-display { position: absolute; bottom: 5px; right: 15px; font-size: 0.7rem; color: var(--text-secondary); opacity: 0.5; user-select: none; }
    </style>
</head>
<body>
    <div id="app-container">
        <!-- –û—Å–Ω–æ–≤–Ω–æ–π —á–∞—Ç -->
        <div id="chat">
            <div id="header"><button id="historyBtn" class="header-btn" title="–ß–∞—Ç—ã">üóÇÔ∏è</button><h2 id="chat-title">–ù–æ–≤—ã–π —á–∞—Ç</h2><div id="header-controls"><div id="auth-container"><button id="authBtn" class="header-btn" title="–í–æ–π—Ç–∏">üë§</button><div id="user-avatar" title="–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –≤—ã–π—Ç–∏" style="display: none;"></div></div><button id="newChatBtn" class="header-btn" title="–ù–æ–≤—ã–π —á–∞—Ç">‚ûï</button><button id="settingsBtn" class="header-btn" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">‚öôÔ∏è</button></div></div>
            <div id="msgs"></div>
            <div id="toolbar"><div id="image-preview-container"><img id="preview-image" src="" alt="Image preview"><button id="remove-image-btn">√ó</button></div><div id="input-row"><button id="attach-btn" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ">üìé</button><input id="userInput" placeholder="–°–ø—Ä–æ—Å–∏—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ –∫–∞—Ä—Ç–∏–Ω–∫—É..." autocomplete="off"/><button id="sendBtn">‚Üí</button></div></div>
            <div id="version-display">v1.2</div>
        </div>
        
        <!-- –ü–∞–Ω–µ–ª–∏ –∏ –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ (HTML –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) -->
        <div id="history-panel" class="side-panel"><h2 class="panel-header">–ß–∞—Ç—ã</h2><div class="panel-content"><ul id="chat-list"></ul></div></div>
        <div id="settings-panel" class="side-panel"><h2 class="panel-header">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2><div class="panel-content"><div class="settings-section"><h3>–°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç</h3><textarea id="system-prompt" placeholder="–ó–∞–¥–∞–π—Ç–µ –ª–∏—á–Ω–æ—Å—Ç—å –¥–ª—è AI..."></textarea></div><div class="settings-section"><h3>–í–µ—Ä—Å–∏—è –ò–ò</h3><select id="model-select"><option value="pro">Gemini 2.0 Pro (Exp)</option><option value="medium" selected>Medium AI (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)</option><option value="mini">Mini AI</option></select></div><div class="settings-section"><h3>–¢–µ–º–∞</h3><div class="theme-options"><div class="theme-dot" data-theme="theme-dark" style="background: #282c34;"></div><div class="theme-dot" data-theme="theme-light" style="background: #ffffff;"></div><div class="theme-dot" data-theme="theme-oceanic" style="background: #203a43;"></div></div></div></div></div>
        <div id="auth-modal" class="modal-overlay"><div class="modal-content"><h3>–í–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç</h3><p>–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏.</p><input id="name-input" type="text" placeholder="–í–∞—à–µ –∏–º—è"><button id="login-submit-btn">–í–æ–π—Ç–∏</button></div></div>
        <div id="overlay"></div>
    </div>

    <script>
        const API_URL = "https://openrouter.ai/api/v1/chat/completions";
        const KEY = "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";

        // --- DOM –≠–ª–µ–º–µ–Ω—Ç—ã (–ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô, –ù–ê–î–ï–ñ–ù–´–ô –°–ü–û–°–û–ë) ---
        const msgs = document.getElementById("msgs");
        const userInput = document.getElementById("userInput");
        const sendBtn = document.getElementById("sendBtn");
        const historyBtn = document.getElementById("historyBtn");
        const settingsBtn = document.getElementById("settingsBtn");
        const newChatBtn = document.getElementById("newChatBtn");
        const chatTitle = document.getElementById("chat-title");
        const overlay = document.getElementById("overlay");
        const attachBtn = document.getElementById('attach-btn');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const previewImage = document.getElementById('preview-image');
        const removeImageBtn = document.getElementById('remove-image-btn');
        const historyPanel = document.getElementById("history-panel");
        const settingsPanel = document.getElementById("settings-panel");
        const chatList = document.getElementById("chat-list");
        const systemPromptInput = document.getElementById('system-prompt');
        const modelSelect = document.getElementById('model-select');
        const authBtn = document.getElementById('authBtn');
        const userAvatar = document.getElementById('user-avatar');
        const authModal = document.getElementById('auth-modal');
        const nameInput = document.getElementById('name-input');
        const loginSubmitBtn = document.getElementById('login-submit-btn');

        // --- –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ---
        let chats = [], currentChatId = null, isProcessing = false, userName = null, attachedImageUrl = null;

        // --- –û–±—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏ —É—Ç–∏–ª–∏—Ç—ã (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
        const updateAuthState = () => { userName = localStorage.getItem('ai_userName'); if (userName) { authBtn.style.display = 'none'; userAvatar.style.display = 'flex'; userAvatar.textContent = userName.charAt(0).toUpperCase(); } else { authBtn.style.display = 'flex'; userAvatar.style.display = 'none'; } };
        const login = () => { const name = nameInput.value.trim(); if (name) { localStorage.setItem('ai_userName', name); updateAuthState(); authModal.style.display = 'none'; } };
        const logout = () => { if (confirm(`–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞ "${userName}"?`)) { localStorage.removeItem('ai_userName'); updateAuthState(); } };
        const appendMessage = (sender, text, cls) => { const div = document.createElement("div"); div.className = `msg ${cls}`; div.textContent = text; msgs.appendChild(div); msgs.scrollTop = msgs.scrollHeight; return div; };
        const typewriterEffect = (element, text) => new Promise(resolve => { let i = 0; element.textContent = ""; const interval = setInterval(() => { if (i < text.length) { element.textContent += text.charAt(i++); msgs.scrollTop = msgs.scrollHeight; } else { clearInterval(interval); resolve(); } }, 25); });
        const saveChats = () => localStorage.setItem('ai_chats_v3', JSON.stringify(chats));
        const loadChats = () => JSON.parse(localStorage.getItem('ai_chats_v3') || '[]');
        const renderChatList = () => { chatList.innerHTML = ''; chats.forEach(chat => { const li = document.createElement('li'); li.textContent = chat.title; li.dataset.id = chat.id; li.className = chat.id === currentChatId ? 'active' : ''; li.addEventListener('click', () => switchChat(chat.id)); const deleteBtn = document.createElement('button'); deleteBtn.className = 'delete-chat-btn'; deleteBtn.innerHTML = 'üóëÔ∏è'; deleteBtn.onclick = (e) => { e.stopPropagation(); deleteChat(chat.id); }; li.appendChild(deleteBtn); chatList.appendChild(li); }); };
        const switchChat = (id) => { currentChatId = id; const chat = chats.find(c => c.id === id); if (!chat) return; msgs.innerHTML = ''; chat.messages.forEach(msg => { const textContent = Array.isArray(msg.content) ? msg.content.find(c => c.type === 'text')?.text || '(–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ)' : msg.content; appendMessage(msg.role === 'user' ? '–í—ã' : '–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç', textContent, msg.role); }); chatTitle.textContent = chat.title; renderChatList(); closePanels(); };
        const createNewChat = () => { const newChat = { id: Date.now(), title: "–ù–æ–≤—ã–π —á–∞—Ç", messages: [] }; chats.unshift(newChat); currentChatId = newChat.id; switchChat(currentChatId); saveChats(); };
        const deleteChat = (id) => { chats = chats.filter(c => c.id !== id); if (currentChatId === id) { currentChatId = chats.length > 0 ? chats[0].id : null; if (currentChatId) switchChat(currentChatId); else createNewChat(); } saveChats(); renderChatList(); };
        const attachImage = () => { const url = prompt("–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (URL):"); if (url) { attachedImageUrl = url; previewImage.src = url; imagePreviewContainer.style.display = 'block'; } };
        const removeAttachedImage = () => { attachedImageUrl = null; previewImage.src = ''; imagePreviewContainer.style.display = 'none'; };
        const closePanels = () => { historyPanel.classList.remove('active'); settingsPanel.classList.remove('active'); overlay.style.display = 'none'; };
        const applyTheme = (themeName) => { document.body.className = themeName; localStorage.setItem('ai_theme', themeName); document.querySelectorAll('.theme-dot').forEach(dot => dot.classList.toggle('active', dot.dataset.theme === themeName)); };
        const saveSettings = () => { localStorage.setItem('ai_model_tier', modelSelect.value); localStorage.setItem('ai_system_prompt', systemPromptInput.value); };

        // --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–æ–π –∏ –æ—à–∏–±–∫–∞–º–∏ (—É–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è) ---
        const showLoader = (show) => {
            isProcessing = show;
            userInput.disabled = show;
            sendBtn.disabled = show;
            sendBtn.innerHTML = show ? '<div class="loader"></div>' : '‚Üí';
            if (!show) {
                userInput.focus();
            }
        };

        const handleApiError = (status) => {
            showLoader(false);
            let errorMessage;

            switch (status) {
                case 401:
                    errorMessage = "–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (–û—à–∏–±–∫–∞ 401).\n–í–∞—à API –∫–ª—é—á –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –∏–ª–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω. –ú—ã –Ω–µ –º–æ–∂–µ–º —ç—Ç–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –±–µ–∑ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∫–ª—é—á–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–ª—é—á –≤ –∫–æ–¥–µ.";
                    break;
                case 429:
                    errorMessage = "–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ (–û—à–∏–±–∫–∞ 429).\n–°–µ—Ä–≤–µ—Ä –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã. –≠—Ç–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ API, –º—ã –Ω–µ –º–æ–∂–µ–º —ç—Ç–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ –º–∏–Ω—É—Ç—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.";
                    // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞ 30 —Å–µ–∫—É–Ω–¥ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Å–ø–∞–º–∞
                    sendBtn.disabled = true;
                    sendBtn.classList.add('cooldown');
                    setTimeout(() => {
                        sendBtn.disabled = false;
                        sendBtn.classList.remove('cooldown');
                    }, 30000);
                    break;
                default:
                    errorMessage = `–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ API (–ö–æ–¥: ${status || 'N/A'}).\n–°–µ—Ä–≤–µ—Ä –º–æ–≥ –±—ã—Ç—å –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω –∏–ª–∏ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ú—ã –Ω–µ –º–æ–∂–µ–º –ø–æ–≤–ª–∏—è—Ç—å –Ω–∞ —ç—Ç–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–ø—Ä–æ—Å –ø–æ–∑–∂–µ.`;
            }
            appendMessage("–°–∏—Å—Ç–µ–º–∞", errorMessage, "bot error");
        };
        
        // --- –û—Ç–ø—Ä–∞–≤–∫–∞ –°–æ–æ–±—â–µ–Ω–∏—è ---
        const sendMessage = async () => {
            if (isProcessing) return;
            const text = userInput.value.trim();
            if (!text && !attachedImageUrl) return;

            showLoader(true);
            const currentChat = chats.find(c => c.id === currentChatId);
            
            const messageContent = [];
            if (text) messageContent.push({ type: 'text', text: text });
            if (attachedImageUrl) messageContent.push({ type: 'image_url', image_url: { url: attachedImageUrl } });
            
            if (currentChat.messages.length === 0 && text) { currentChat.title = text.substring(0, 30); chatTitle.textContent = currentChat.title; renderChatList(); }
            
            currentChat.messages.push({ role: 'user', content: messageContent });
            appendMessage("–í—ã", text || "(–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ)", "user");
            userInput.value = "";
            removeAttachedImage();
            
            const messagesForApi = [...currentChat.messages];
            let systemPrompt = systemPromptInput.value.trim();
            if (userName) { systemPrompt = `–¢–≤–æ–µ–≥–æ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ –∑–æ–≤—É—Ç ${userName}. –û–±—Ä–∞—â–∞–π—Å—è –∫ –Ω–µ–º—É –ø–æ –∏–º–µ–Ω–∏, –∫–æ–≥–¥–∞ —ç—Ç–æ —É–º–µ—Å—Ç–Ω–æ. ${systemPrompt}`; }
            if (systemPrompt) messagesForApi.unshift({ role: 'system', content: systemPrompt });
            
            try {
                const res = await fetch(API_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${KEY}` },
                    body: JSON.stringify({ model: "google/gemini-2.0-flash-exp:free", messages: messagesForApi })
                });

                if (!res.ok) {
                    handleApiError(res.status);
                    return;
                }
                
                const js = await res.json();
                const reply = js.choices?.[0]?.message?.content || "–ü–æ–ª—É—á–µ–Ω –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞.";
                showLoader(false);
                const botMsgElement = appendMessage("–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç", "", "bot");
                await typewriterEffect(botMsgElement, reply);
                currentChat.messages.push({ role: 'assistant', content: reply });
                saveChats();
            } catch (e) {
                // –≠—Ç–æ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å —Å–µ—Ç—å—é (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞)
                handleApiError(null); 
            }
        };

        // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
        const init = () => {
            updateAuthState(); chats = loadChats(); if (chats.length === 0) createNewChat(); else { currentChatId = chats[0].id; switchChat(currentChatId); }
            const savedTheme = localStorage.getItem('ai_theme') || 'theme-dark'; applyTheme(savedTheme);
            modelSelect.value = localStorage.getItem('ai_model_tier') || 'medium';
            systemPromptInput.value = localStorage.getItem('ai_system_prompt') || '';
            sendBtn.addEventListener("click", sendMessage);
            userInput.addEventListener("keydown", e => { if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendMessage(); } });
            attachBtn.addEventListener('click', attachImage); removeImageBtn.addEventListener('click', removeAttachedImage);
            historyBtn.addEventListener("click", (e) => { e.stopPropagation(); settingsPanel.classList.remove('active'); historyPanel.classList.toggle('active'); overlay.style.display = 'block'; });
            settingsBtn.addEventListener("click", (e) => { e.stopPropagation(); historyPanel.classList.remove('active'); settingsPanel.classList.toggle('active'); overlay.style.display = 'block'; });
            newChatBtn.addEventListener("click", createNewChat); overlay.addEventListener('click', closePanels);
            document.querySelectorAll('.theme-dot').forEach(dot => dot.addEventListener('click', () => applyTheme(dot.dataset.theme)));
            modelSelect.addEventListener('change', saveSettings); systemPromptInput.addEventListener('input', saveSettings);
            authBtn.addEventListener('click', () => { authModal.style.display = 'flex'; nameInput.focus(); });
            userAvatar.addEventListener('click', logout); loginSubmitBtn.addEventListener('click', login);
            nameInput.addEventListener('keydown', e => { if (e.key === 'Enter') login(); });
            authModal.addEventListener('click', (e) => { if (e.target === authModal) authModal.style.display = 'none'; });
        };
        
        init();
    </script>
</body>
</html>
